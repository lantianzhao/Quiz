<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBBS Exam Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .sidebar-scroll::-webkit-scrollbar { width: 6px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }

        .option-btn { transition: all 0.2s; }
        .option-btn:hover { background-color: #f9fafb; border-color: #9ca3af; }
        .option-btn.selected {
            background-color: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
            font-weight: 600;
            box-shadow: 0 0 0 1px #3b82f6;
        }

        .option-btn.review-correct {
            background-color: #d1fae5 !important;
            border-color: #10b981 !important;
            color: #065f46 !important;
        }
        .option-btn.review-wrong {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #991b1b !important;
        }

        .nav-item {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            background-color: white;
            color: #64748b;
            border-color: #e2e8f0;
        }
        .nav-item:hover { border-color: #94a3b8; }
        .nav-item.active { border-color: #2563eb; color: #2563eb; ring: 2px solid #bfdbfe; }
        .nav-item.answered { background-color: #dbeafe; color: #1e40af; border-color: #dbeafe; }
        
        .nav-item.nav-correct { background-color: #10b981; color: white; border-color: #10b981; }
        .nav-item.nav-wrong { background-color: #ef4444; color: white; border-color: #ef4444; }

        .highlight-yellow { 
            background-color: #fef08a; 
            padding: 2px 0; 
            border-radius: 2px; 
            cursor: pointer; 
        }
        .highlight-yellow:hover {
            background-color: #fde047;
        }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 overflow-hidden relative">

    <!-- ================= 1. HOME SCREEN ================= -->
    <div id="home-screen" class="flex-grow flex items-center justify-center p-4 fade-in overflow-y-auto">
        <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl p-8 md:p-12 text-center my-auto">
            <h1 class="text-4xl font-extrabold text-blue-900 mb-2">MBBS Exam Simulator</h1>
            <p class="text-gray-500 mb-8">Second Year MBBS Practice • Exam Mode</p>

            <div id="loading-status" class="mb-8 p-4 bg-blue-50 rounded-lg text-blue-700 text-sm font-medium animate-pulse border border-blue-100">
                Fetching latest questions from database...
            </div>

            <div class="bg-gray-50 rounded-xl p-6 mb-8 text-left border border-gray-100">
                <label class="block text-sm font-bold text-gray-700 mb-3">⏱️ Exam Timer (Minutes)</label>
                <div class="flex items-center space-x-4">
                    <input type="number" id="time-input" value="10" min="0" max="180" class="w-24 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-center text-lg font-bold">
                    <span class="text-sm text-gray-500">Set to 0 for unlimited time.</span>
                </div>
            </div>

            <button id="start-btn" type="button" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transform transition hover:-translate-y-1 mb-8 text-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Start Exam
            </button>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-8 border-t border-gray-100">
                <a href="https://docs.google.com/spreadsheets/d/1_gZrItBTPDVj6OLJyQReQm8yFtszS0F5nbJFT91InvE/edit?gid=0#gid=0" target="_blank" class="flex items-center justify-center space-x-2 px-4 py-3 bg-white border border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 hover:text-blue-600 transition shadow-sm font-medium">
                    <span>Edit Questions (Generator)</span>
                </a>
                <a href="https://docs.google.com/spreadsheets/d/1nEB7GqjzAdabQmq8IHUBEes33f8r7NEtndwvF42Cjgo/edit?gid=0#gid=0" target="_blank" class="flex items-center justify-center space-x-2 px-4 py-3 bg-white border border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 hover:text-green-600 transition shadow-sm font-medium">
                    <span>Correction Sheet</span>
                </a>
            </div>
        </div>
    </div>

    <!-- ================= 2. QUIZ / REVIEW SCREEN ================= -->
    <div id="quiz-screen" class="hidden h-screen flex-col fade-in bg-white">
        
        <!-- Header -->
        <div class="h-16 border-b border-gray-200 flex items-center justify-between px-4 md:px-6 bg-white shrink-0 z-20 shadow-sm">
            <div class="font-bold text-gray-700 text-lg">Question <span id="current-q-num">1</span> of <span id="total-q-num">--</span></div>
            
            <div class="flex items-center space-x-2 md:space-x-4">
                <!-- Highlight Tool -->
                <button id="highlight-btn" type="button" class="flex items-center space-x-1 px-3 py-1.5 bg-yellow-100 text-yellow-800 rounded hover:bg-yellow-200 transition border border-yellow-300 select-none">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    <span class="text-sm font-bold hidden md:inline">Highlight</span>
                </button>
                
                <!-- Timer -->
                <div id="timer-display" class="text-xl font-mono font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded border border-blue-100">--:--</div>
                
                <!-- Header Submit Button -->
                <button id="submit-btn-header" class="px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-bold shadow-sm">
                    Submit
                </button>

                <!-- Exit Review Button -->
                <button id="exit-review-btn" class="hidden px-4 py-1.5 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm font-bold">Exit</button>
            </div>
        </div>

        <div class="flex-grow flex overflow-hidden">
            <!-- Sidebar -->
            <div class="w-72 bg-gray-50 border-r border-gray-200 flex flex-col shrink-0 hidden md:flex">
                <div class="p-4 border-b border-gray-200 bg-gray-100 text-xs font-bold text-gray-500 uppercase tracking-wider">
                    Question Navigator
                </div>
                <div id="sidebar-container" class="p-4 grid grid-cols-4 gap-3 overflow-y-auto sidebar-scroll content-start"></div>
                <div class="p-4 border-t border-gray-200 bg-white">
                    <button id="submit-btn-sidebar" type="button" class="w-full py-2 bg-green-600 text-white font-bold rounded shadow hover:bg-green-700 transition">
                        Submit Exam
                    </button>
                </div>
            </div>

            <!-- Question Area -->
            <div class="flex-grow overflow-y-auto p-4 md:p-10 bg-gray-50">
                <div class="max-w-3xl mx-auto">
                    <div class="md:hidden mb-4 overflow-x-auto whitespace-nowrap pb-2" id="mobile-nav-container"></div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 md:p-10 min-h-[500px]">
                        <!-- Question Text -->
                        <div id="question-text-container" class="text-lg md:text-xl font-medium text-gray-900 leading-relaxed mb-8 selection:bg-yellow-200 selection:text-black"></div>
                        
                        <!-- Options -->
                        <div id="options-container" class="space-y-3"></div>

                        <!-- Explanation -->
                        <div id="explanation-container" class="hidden mt-8 bg-blue-50 p-6 rounded-lg border border-blue-100 fade-in">
                            <h3 class="text-sm font-bold text-blue-800 uppercase tracking-wide mb-2">Explanation</h3>
                            <div id="explanation-text" class="text-blue-900 leading-relaxed"></div>
                        </div>

                        <!-- Footer Nav -->
                        <div class="flex justify-between mt-10 pt-6 border-t border-gray-100">
                            <button id="prev-btn" type="button" class="px-6 py-2 bg-white border border-gray-300 text-gray-700 font-medium rounded hover:bg-gray-50 disabled:opacity-50">Previous</button>
                            <button id="next-btn" type="button" class="px-6 py-2 bg-blue-600 text-white font-medium rounded hover:bg-blue-700 shadow-sm">Next Question</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= 3. SUMMARY SCREEN ================= -->
    <div id="summary-screen" class="hidden flex-grow flex items-center justify-center p-4 fade-in bg-gray-50 h-screen">
        <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-8 md:p-12 text-center">
            <h2 class="text-3xl font-extrabold text-gray-900 mb-2">Exam Summary</h2>
            <p class="text-gray-500 mb-8">You have completed the exam.</p>

            <div class="flex justify-center items-center space-x-12 mb-10">
                <div class="text-center">
                    <div class="text-5xl font-extrabold text-blue-600 mb-1" id="summary-score">0/0</div>
                    <div class="text-xs text-gray-500 uppercase tracking-widest font-semibold">Total Score</div>
                </div>
                <div class="w-px h-16 bg-gray-200"></div>
                <div class="text-center">
                    <div class="text-5xl font-extrabold text-gray-800 mb-1" id="summary-percent">0%</div>
                    <div class="text-xs text-gray-500 uppercase tracking-widest font-semibold">Percentage</div>
                </div>
            </div>

            <div class="space-y-3">
                <button id="review-questions-btn" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition">
                    Review Questions
                </button>
                <button id="back-home-btn" class="w-full py-4 bg-white border-2 border-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-50 transition">
                    Back to Home Page
                </button>
            </div>
        </div>
    </div>

    <!-- ================= 4. CONFIRM MODAL ================= -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full transform scale-100 transition-transform">
            <h3 class="text-xl font-bold text-gray-900 mb-2">Submit Exam?</h3>
            <p class="text-gray-600 mb-6" id="modal-text">You have answered X of Y questions.</p>
            <div class="flex space-x-3">
                <button id="modal-cancel" class="flex-1 py-2 bg-gray-100 text-gray-700 font-bold rounded-lg hover:bg-gray-200">Cancel</button>
                <button id="modal-confirm" class="flex-1 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Submit</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const API_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSH7UcYnc_kaF7q5nm9tWYSjS8DEE12SGwi97psvcERZdv7mm1AedCqEsidSTmoxsCSlKbcqJv9NTVP/pub?gid=0&single=true&output=csv';
            
            // --- STATE ---
            let questions = [];
            let userAnswers = {}; 
            let questionHighlights = {}; // { [qIndex]: [{start, end}] }
            let questionHTMLStates = {}; 
            let currentQuestionIndex = 0;
            let timerInterval;
            let timeLeftSeconds = 0;
            let isReviewMode = false;

            // --- DOM ELEMENTS ---
            const homeScreen = document.getElementById('home-screen');
            const quizScreen = document.getElementById('quiz-screen');
            const summaryScreen = document.getElementById('summary-screen');
            const loadingStatus = document.getElementById('loading-status');
            const modal = document.getElementById('custom-modal');
            const modalText = document.getElementById('modal-text');
            const modalConfirmBtn = document.getElementById('modal-confirm');
            const modalCancelBtn = document.getElementById('modal-cancel');
            
            // Buttons
            const startBtn = document.getElementById('start-btn');
            const timeInput = document.getElementById('time-input');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtnSidebar = document.getElementById('submit-btn-sidebar');
            const submitBtnHeader = document.getElementById('submit-btn-header');
            const highlightBtn = document.getElementById('highlight-btn');
            const reviewQuestionsBtn = document.getElementById('review-questions-btn');
            const backHomeBtn = document.getElementById('back-home-btn');
            const exitReviewBtn = document.getElementById('exit-review-btn');

            // Display
            const currentQNum = document.getElementById('current-q-num');
            const totalQNum = document.getElementById('total-q-num');
            const timerDisplay = document.getElementById('timer-display');
            const questionContainer = document.getElementById('question-text-container');
            const optionsContainer = document.getElementById('options-container');
            const sidebarContainer = document.getElementById('sidebar-container');
            const mobileNavContainer = document.getElementById('mobile-nav-container');
            const explanationContainer = document.getElementById('explanation-container');
            const explanationText = document.getElementById('explanation-text');
            const summaryScore = document.getElementById('summary-score');
            const summaryPercent = document.getElementById('summary-percent');

            // --- 1. FETCH DATA ---
            async function fetchQuestions() {
                try {
                    const response = await fetch(API_URL);
                    const csvText = await response.text();
                    const rows = csvText.trim().split('\n');
                    questions = []; 
                    for (let i = 1; i < rows.length; i++) {
                        if (!rows[i].trim()) continue;
                        const values = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); 
                        const clean = (val) => val ? val.trim().replace(/^"|"$/g, '').replace(/""/g, '"') : '';
                        const q = {
                            Question: clean(values[0]),
                            OptionA: clean(values[1]),
                            OptionB: clean(values[2]),
                            OptionC: clean(values[3]),
                            OptionD: clean(values[4]),
                            OptionE: clean(values[5]),
                            CorrectAnswer: clean(values[6]).toUpperCase(),
                            Explanation: clean(values[7])
                        };
                        if (q.Question && ['A','B','C','D','E'].includes(q.CorrectAnswer)) {
                            questions.push(q);
                        }
                    }
                    if (questions.length > 0) {
                        loadingStatus.textContent = `✅ Loaded ${questions.length} questions. Ready.`;
                        loadingStatus.className = "mb-8 p-4 bg-green-50 rounded-lg text-green-700 text-sm font-medium border border-green-100";
                        startBtn.disabled = false;
                    }
                } catch (error) {
                    loadingStatus.textContent = "❌ Error loading. Check internet connection.";
                    loadingStatus.className = "mb-8 p-4 bg-red-50 rounded-lg text-red-700 text-sm font-medium border border-red-100";
                }
            }

            // --- 2. EXAM CONTROL ---
            function startExam() {
                userAnswers = {};
                questionHighlights = {};
                questionHTMLStates = {};
                isReviewMode = false;
                currentQuestionIndex = 0;
                
                const minutes = parseInt(timeInput.value);
                if (minutes && minutes > 0) {
                    timeLeftSeconds = minutes * 60;
                    startTimer();
                } else {
                    timerDisplay.textContent = "∞";
                }

                homeScreen.classList.add('hidden');
                summaryScreen.classList.add('hidden');
                quizScreen.classList.remove('hidden');
                quizScreen.style.display = 'flex';
                
                submitBtnSidebar.classList.remove('hidden');
                submitBtnHeader.classList.remove('hidden');
                exitReviewBtn.classList.add('hidden');
                
                totalQNum.textContent = questions.length;
                renderSidebar();
                renderQuestion(0);
            }

            function finishExam() {
                clearInterval(timerInterval);
                modal.classList.add('hidden');
                
                let correctCount = 0;
                questions.forEach((q, index) => {
                    if (userAnswers[index] === q.CorrectAnswer) correctCount++;
                });

                summaryScore.textContent = `${correctCount}/${questions.length}`;
                const percent = Math.round((correctCount / questions.length) * 100) || 0;
                summaryPercent.textContent = `${percent}%`;

                if (percent >= 80) summaryPercent.className = "text-5xl font-extrabold text-green-600 mb-1";
                else if (percent >= 50) summaryPercent.className = "text-5xl font-extrabold text-yellow-600 mb-1";
                else summaryPercent.className = "text-5xl font-extrabold text-red-600 mb-1";

                quizScreen.classList.add('hidden');
                quizScreen.style.display = 'none';
                summaryScreen.classList.remove('hidden');
                summaryScreen.style.display = 'flex';
                window.scrollTo(0, 0);
            }

            function startReviewMode() {
                isReviewMode = true;
                summaryScreen.classList.add('hidden');
                quizScreen.classList.remove('hidden');
                quizScreen.style.display = 'flex';
                
                submitBtnSidebar.classList.add('hidden');
                submitBtnHeader.classList.add('hidden');
                exitReviewBtn.classList.remove('hidden');
                
                renderSidebar();
                renderQuestion(0);
            }

            // --- 3. RENDERING ---
            function renderQuestion(index) {
                currentQuestionIndex = index;
                currentQNum.textContent = index + 1;
                const q = questions[index];
                
                // Initialize highlights if not present
                if (!questionHighlights[index]) questionHighlights[index] = [];
                // Render with highlights
                renderQuestionWithHighlights(index);

                // Options
                optionsContainer.innerHTML = '';
                ['A', 'B', 'C', 'D', 'E'].forEach(letter => {
                    const text = q[`Option${letter}`];
                    if (!text && letter === 'E') return;

                    const btn = document.createElement('button');
                    let baseClasses = `option-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 bg-white text-gray-700 text-lg flex items-start `;
                    
                    if (isReviewMode) {
                        if (letter === q.CorrectAnswer) baseClasses += "review-correct font-bold ";
                        else if (userAnswers[index] === letter) baseClasses += "review-wrong ";
                    } else {
                        if (userAnswers[index] === letter) baseClasses += "selected ";
                    }
                    
                    btn.className = baseClasses;
                    btn.innerHTML = `<span class="font-bold mr-3 text-gray-400 w-6">${letter}</span> <span>${text}</span>`;
                    
                    if (!isReviewMode) {
                        btn.onclick = () => {
                            userAnswers[index] = letter;
                            updateSidebarStyles();
                            renderQuestion(index);
                        };
                    }
                    optionsContainer.appendChild(btn);
                });

                // Explanation
                if (isReviewMode) {
                    explanationContainer.classList.remove('hidden');
                    explanationText.innerHTML = q.Explanation || "No explanation provided.";
                } else {
                    explanationContainer.classList.add('hidden');
                }

                // Nav Buttons
                prevBtn.disabled = index === 0;
                
                if (index === questions.length - 1) {
                    if (isReviewMode) {
                        nextBtn.textContent = "Finish Review";
                        nextBtn.onclick = () => location.reload();
                    } else {
                        nextBtn.textContent = "Submit Exam";
                        nextBtn.onclick = showSubmitModal;
                    }
                } else {
                    nextBtn.textContent = "Next Question";
                    nextBtn.onclick = () => {
                        renderQuestion(index + 1);
                    };
                }

                updateSidebarStyles();
            }

            function renderSidebar() {
                sidebarContainer.innerHTML = '';
                mobileNavContainer.innerHTML = '';
                
                questions.forEach((q, index) => {
                    const navItem = document.createElement('div');
                    navItem.textContent = index + 1;
                    navItem.id = `nav-${index}`;
                    
                    const mobileItem = navItem.cloneNode(true);
                    mobileItem.id = `mobile-nav-${index}`;

                    const handleClick = () => {
                        renderQuestion(index);
                    };
                    navItem.onclick = handleClick;
                    mobileItem.onclick = handleClick;

                    sidebarContainer.appendChild(navItem);
                    mobileNavContainer.appendChild(mobileItem);
                });
                updateSidebarStyles();
            }

            function updateSidebarStyles() {
                questions.forEach((q, index) => {
                    const el = document.getElementById(`nav-${index}`);
                    const mobEl = document.getElementById(`mobile-nav-${index}`);
                    if (!el) return;

                    let classes = "nav-item ";
                    if (mobEl) mobEl.className = "nav-item inline-flex mr-2 shrink-0 ";

                    if (isReviewMode) {
                        if (userAnswers[index] === q.CorrectAnswer) classes += "nav-correct ";
                        else if (userAnswers[index]) classes += "nav-wrong ";
                        else classes += "border-gray-200 ";
                    } else {
                        if (userAnswers[index]) classes += "answered ";
                    }

                    if (index === currentQuestionIndex) {
                        classes += "active ring-2 ring-blue-300 ";
                    }

                    el.className = classes;
                    if(mobEl) mobEl.className = classes + "inline-flex mr-2 shrink-0";
                    
                    if (index === currentQuestionIndex) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                });
            }

            // --- 4. HIGHLIGHTER HELPERS ---
            function getTextAndMap(root) {
                const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null, false);
                let node, text = '';
                const map = [];
                let abs = 0;
                while ((node = walker.nextNode())) {
                    const t = node.nodeValue;
                    if (!t) continue;
                    const start = abs;
                    const end = start + t.length;
                    map.push({ node, startInNode: 0, absStart: start, absEnd: end });
                    text += t;
                    abs = end;
                }
                return { text, map };
            }

            function rangeToOffsets(range, map) {
                const { startContainer, startOffset, endContainer, endOffset } = range;
                function findAbs(container, offset) {
                    for (const seg of map) {
                        if (seg.node === container) return seg.absStart + offset;
                    }
                    let node = container;
                    while (node && node.firstChild) node = node.firstChild;
                    if (node && node.nodeType === 3) {
                        const seg = map.find(s => s.node === node);
                        if (seg) return seg.absStart + Math.min(offset, node.nodeValue.length);
                    }
                    return null;
                }
                const absStart = findAbs(startContainer, startOffset);
                const absEnd = findAbs(endContainer, endOffset);
                if (absStart == null || absEnd == null) return null;
                const start = Math.min(absStart, absEnd);
                const end = Math.max(absStart, absEnd);
                if (start === end) return null;
                return { start, end };
            }

            function mergeRangesInPlace(ranges) {
                ranges.sort((a,b) => a.start - b.start || a.end - b.end);
                const merged = [];
                for (const r of ranges) {
                    if (!merged.length || r.start > merged[merged.length-1].end) {
                        merged.push({ ...r });
                    } else {
                        merged[merged.length-1].end = Math.max(merged[merged.length-1].end, r.end);
                    }
                }
                ranges.length = 0;
                ranges.push(...merged);
            }

            function escapeHtml(s) {
                return s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
            }

            function renderQuestionWithHighlights(index) {
                const q = questions[index];
                const source = q.Question;
                const ranges = (questionHighlights[index] || []).slice().sort((a,b)=>a.start-b.start);
                
                let html = '';
                let cursor = 0;
                for (const r of ranges) {
                    const start = Math.max(0, Math.min(source.length, r.start));
                    const end = Math.max(0, Math.min(source.length, r.end));
                    if (end <= cursor) continue;
                    if (start > cursor) html += escapeHtml(source.slice(cursor, start));
                    html += `<span class="highlight-yellow">${escapeHtml(source.slice(start, end))}</span>`;
                    cursor = end;
                }
                if (cursor < source.length) html += escapeHtml(source.slice(cursor));
                
                questionContainer.innerHTML = html || escapeHtml(source);
                questionHTMLStates[index] = questionContainer.innerHTML;
            }

            function handleHighlightAction() {
                const selection = window.getSelection();
                if (!selection.rangeCount || selection.isCollapsed) return;
                const range = selection.getRangeAt(0);

                if (!questionContainer.contains(range.commonAncestorContainer)) return;

                const { text, map } = getTextAndMap(questionContainer);
                const offsets = rangeToOffsets(range, map);
                if (!offsets) return;

                const idx = currentQuestionIndex;
                if (!questionHighlights[idx]) questionHighlights[idx] = [];
                const list = questionHighlights[idx];

                // Check for exact match removal
                const existingIdx = list.findIndex(r => r.start === offsets.start && r.end === offsets.end);
                if (existingIdx !== -1) {
                    list.splice(existingIdx, 1);
                } else {
                    list.push(offsets);
                    mergeRangesInPlace(list);
                }

                renderQuestionWithHighlights(idx);
                selection.removeAllRanges();
            }

            // --- 5. EVENT LISTENERS ---
            highlightBtn.addEventListener('click', (e) => {
                e.preventDefault();
                handleHighlightAction();
            });

            questionContainer.addEventListener('click', (e) => {
                const span = e.target.closest('.highlight-yellow');
                if (!span) return;
                const selection = window.getSelection();
                selection.removeAllRanges();
                const range = document.createRange();
                range.selectNodeContents(span);
                selection.addRange(range);
                handleHighlightAction();
            });

            // --- 6. SUBMIT LOGIC ---
            function showSubmitModal() {
                const answered = Object.keys(userAnswers).length;
                const total = questions.length;
                modalText.textContent = `You have answered ${answered} out of ${total} questions.`;
                modal.classList.remove('hidden');
            }

            modalCancelBtn.onclick = () => modal.classList.add('hidden');
            modalConfirmBtn.onclick = finishExam;

            // --- 7. TIMER ---
            function startTimer() {
                updateTimerDisplay();
                timerInterval = setInterval(() => {
                    timeLeftSeconds--;
                    updateTimerDisplay();
                    if (timeLeftSeconds <= 0) {
                        clearInterval(timerInterval);
                        alert("Time's up!");
                        finishExam();
                    }
                }, 1000);
            }

            function updateTimerDisplay() {
                const m = Math.floor(timeLeftSeconds / 60);
                const s = timeLeftSeconds % 60;
                timerDisplay.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                if (timeLeftSeconds < 60) {
                    timerDisplay.classList.add('text-red-600', 'bg-red-50');
                }
            }

            // Bindings
            startBtn.onclick = startExam;
            submitBtnSidebar.onclick = showSubmitModal;
            submitBtnHeader.onclick = showSubmitModal;
            reviewQuestionsBtn.onclick = startReviewMode;
            backHomeBtn.onclick = () => location.reload();
            exitReviewBtn.onclick = () => location.reload();
            
            prevBtn.onclick = () => {
                if (currentQuestionIndex > 0) renderQuestion(currentQuestionIndex - 1);
            };

            await fetchQuestions();
        });
    </script>
</body>
</html>